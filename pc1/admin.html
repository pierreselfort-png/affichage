<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Pilotage écrans - Chef d’atelier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b0f14;
      color: #fff;
      padding: 40px;
    }
    .card {
      max-width: 820px;
      margin: auto;
      background: #111827;
      padding: 28px;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    }
    h2, h3 { margin: 0 0 14px; }
    .muted { opacity: .75; }
    label { display: block; margin-top: 14px; font-size: 14px; opacity: .85; }
    select, textarea, input, button {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #2b3340;
      background: #0b1220;
      color: #fff;
      box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 110px; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .btn {
      margin-top: 16px;
      background: #2563eb;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:hover { filter: brightness(1.07); }
    .btn.secondary {
      background: #1f2937;
      border: 1px solid #2b3340;
      font-weight: 600;
    }
    .status {
      margin-top: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      min-height: 22px;
      white-space: pre-line;
    }
    hr {
      margin: 26px 0;
      border: none;
      border-top: 1px solid rgba(255,255,255,0.12);
    }
    .pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.15);
      border: 1px solid rgba(37, 99, 235, 0.35);
      color: #cfe0ff;
      font-size: 12px;
      margin-left: 8px;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>Interface Chef d’atelier <span class="pill">Google Sheet</span></h2>
    <div class="muted">Sélectionne un écran, modifie le message / emplacement, ou ajoute un nouvel écran.</div>

    <hr>

    <!-- ===== SECTION MODIFICATION ===== -->
    <h3>Modifier un écran</h3>

    <label>Écran (liste auto depuis le Sheet)</label>
    <select id="screen"></select>

    <div class="row">
      <div>
        <label>Titre (lecture seule)</label>
        <input id="titre" disabled>
      </div>
      <div>
        <label>Emplacement</label>
        <input id="emplacement" placeholder="Ex: Ligne 1 / Atelier / Stockage…">
      </div>
    </div>

    <label>Message (INFO / CONSIGNES)</label>
    <textarea id="message" placeholder="Tape le message à afficher…"></textarea>

    <div class="row">
      <button class="btn" onclick="updateSelected()">Enregistrer</button>
      <button class="btn secondary" onclick="reloadData()">Recharger la liste</button>
    </div>

    <div class="status" id="status"></div>

    <hr>

    <!-- ===== SECTION AJOUT ===== -->
    <h3>Ajouter un nouvel écran</h3>

    <div class="row">
      <div>
        <label>ID (unique) — ex: pc6</label>
        <input id="newId" placeholder="pc6">
      </div>
      <div>
        <label>Titre — ex: PC 6</label>
        <input id="newTitle" placeholder="PC 6">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Emplacement</label>
        <input id="newEmplacement" placeholder="Ex: Ligne 2">
      </div>
      <div>
        <label>Message (optionnel)</label>
        <input id="newMessage" placeholder="Message de départ…">
      </div>
    </div>

    <button class="btn" onclick="addNew()">Ajouter l’écran</button>

    <div class="status" id="statusAdd"></div>
  </div>

<script>
/* ===================== A REMPLACER ===================== */
const API_URL = "COLLE_ICI_TON_URL_APPS_SCRIPT"; 
/* ======================================================= */

/* Elements */
const screenSelect = document.getElementById("screen");
const titreInput = document.getElementById("titre");
const emplacementInput = document.getElementById("emplacement");
const messageInput = document.getElementById("message");
const status = document.getElementById("status");
const statusAdd = document.getElementById("statusAdd");

/* Cache local des lignes du sheet */
let rowsCache = [];

/* Helpers */
function setStatus(el, txt) { el.textContent = txt || ""; }
function normId(s) { return (s || "").trim(); }

/* Charger la liste des écrans depuis l’API */
async function reloadData() {
  setStatus(status, "Chargement…");
  try {
    const r = await fetch(API_URL, { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    rowsCache = await r.json();

    // Filtrer lignes valides
    rowsCache = (Array.isArray(rowsCache) ? rowsCache : []).filter(x => x && x.id);

    // Remplir le select
    screenSelect.innerHTML = "";
    rowsCache.forEach(row => {
      const opt = document.createElement("option");
      opt.value = row.id;
      opt.textContent = (row.titre && String(row.titre).trim()) ? row.titre : row.id;
      screenSelect.appendChild(opt);
    });

    if (rowsCache.length === 0) {
      setStatus(status, "Aucun écran trouvé. Vérifie le Sheet: colonnes id/titre/message/emplacement.");
      titreInput.value = "";
      emplacementInput.value = "";
      messageInput.value = "";
      return;
    }

    // Sélection 1er élément et remplir champs
    screenSelect.value = rowsCache[0].id;
    loadSelectedIntoForm();
    setStatus(status, "Liste chargée ✔");
  } catch (e) {
    setStatus(status, "Erreur de chargement.\nVérifie API_URL et le déploiement Apps Script.\n" + e);
  }
}

/* Charger le PC sélectionné dans le formulaire */
function loadSelectedIntoForm() {
  const id = screenSelect.value;
  const row = rowsCache.find(r => r.id === id);

  titreInput.value = row?.titre ?? "";
  emplacementInput.value = row?.emplacement ?? "";
  messageInput.value = row?.message ?? "";
}

/* Mettre à jour le message + emplacement du PC sélectionné */
async function updateSelected() {
  const id = normId(screenSelect.value);
  const message = messageInput.value ?? "";
  const emplacement = emplacementInput.value ?? "";

  if (!id) { setStatus(status, "ID invalide."); return; }

  setStatus(status, "Envoi…");
  try {
    const r = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "update",
        id,
        message,
        emplacement
      })
    });

    const txt = await r.text();
    setStatus(status, txt === "UPDATED" ? "Mis à jour ✔" : ("Réponse: " + txt));

    // mettre à jour le cache local
    const idx = rowsCache.findIndex(x => x.id === id);
    if (idx >= 0) {
      rowsCache[idx].message = message;
      rowsCache[idx].emplacement = emplacement;
    }
  } catch (e) {
    setStatus(status, "Erreur réseau: " + e);
  }
}

/* Ajouter un nouvel écran */
async function addNew() {
  const id = normId(document.getElementById("newId").value);
  const titre = (document.getElementById("newTitle").value || "").trim();
  const emplacement = (document.getElementById("newEmplacement").value || "").trim();
  const message = (document.getElementById("newMessage").value || "").trim();

  if (!id) { setStatus(statusAdd, "ID obligatoire (ex: pc6)."); return; }
  if (rowsCache.some(r => r.id === id)) { setStatus(statusAdd, "Cet ID existe déjà."); return; }

  setStatus(statusAdd, "Ajout…");
  try {
    const r = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "add",
        id,
        titre,
        message,
        emplacement
      })
    });

    const txt = await r.text();
    setStatus(statusAdd, txt === "ADDED" ? "Ajouté ✔" : ("Réponse: " + txt));

    // reset form
    document.getElementById("newId").value = "";
    document.getElementById("newTitle").value = "";
    document.getElementById("newEmplacement").value = "";
    document.getElementById("newMessage").value = "";

    // reload list
    await reloadData();
  } catch (e) {
    setStatus(statusAdd, "Erreur réseau: " + e);
  }
}

/* Events */
screenSelect.addEventListener("change", loadSelectedIntoForm);

/* Init */
reloadData();
</script>

</body>
</html>
