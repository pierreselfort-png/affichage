<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Affichage Ligne de Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: #0b0f14;
  color: #ffffff;
  font-family: Arial, Helvetica, sans-serif;
}

.screen {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== ADMIN ICON ===== */
.admin-btn {
  position: fixed;
  top: 12px;
  right: 12px;
  font-size: 20px;
  opacity: 0.25;
  cursor: pointer;
  z-index: 100;
}
.admin-btn:hover { opacity: 0.7; }

/* ===== ADMIN PANEL ===== */
.admin-panel {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 200;
}

.admin-box {
  background: #111827;
  padding: 30px;
  width: 420px;
  border-radius: 12px;
}

.admin-box h2 {
  margin-top: 0;
  margin-bottom: 20px;
}

.admin-box label {
  display: block;
  font-size: 14px;
  opacity: 0.8;
  margin-top: 12px;
}

.admin-box input,
.admin-box textarea {
  width: 100%;
  margin-top: 6px;
  padding: 10px;
  font-size: 16px;
  background: #020617;
  color: white;
  border: 1px solid #333;
}

.admin-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 20px;
}

.admin-actions button {
  padding: 12px;
  font-size: 16px;
  cursor: pointer;
}

.close {
  background: #2563eb;
  color: white;
  border: none;
}

.danger {
  background: #dc2626;
  color: white;
  border: none;
}

/* ===== TAKT ===== */
.takt {
  flex: 2;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.takt-label {
  font-size: 36px;
  opacity: 0.7;
}

.takt-time {
  font-size: 180px;
  font-weight: bold;
  letter-spacing: 6px;
}

.takt-sub {
  font-size: 32px;
  opacity: 0.6;
  margin-top: 10px;
}

/* ===== ACTIONS PROD ===== */
.takt-actions {
  margin-top: 25px;
  display: flex;
  gap: 20px;
}

.takt-actions button {
  padding: 14px 26px;
  font-size: 22px;
  background: #111;
  color: white;
  border: 2px solid #333;
  cursor: pointer;
}

.takt-actions button:hover {
  background: #1f2933;
}

.takt-actions .reset {
  border-color: #dc2626;
}

/* ===== PAUSE ===== */
.pause-indicator {
  margin-top: 18px;
  font-size: 34px;
  font-weight: bold;
  color: #facc15;
  display: none;
}

.paused .takt-time {
  opacity: 0.4;
}

/* ===== BAS ===== */
.bottom {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  border-top: 3px solid #222;
}

.card {
  padding: 40px;
  position: relative;
}

.card h2 {
  font-size: 32px;
  opacity: 0.75;
}

.big {
  font-size: 80px;
  font-weight: bold;
}

.small {
  font-size: 32px;
  opacity: 0.7;
}

.info {
  font-size: 40px;
  line-height: 1.4;
  white-space: pre-line;
  transition: opacity .35s;
}

.alert {
  color: #ff4d4d;
}

/* ===== SELECT PC (dans la carte INFO) ===== */
.pc-picker {
  position: absolute;
  right: 40px;
  bottom: 30px;
}

.pc-picker select{
  font-size: 18px;
  padding: 10px 12px;
  background: #111827;
  color: white;
  border: 1px solid #333;
  border-radius: 10px;
}
</style>
</head>

<body>

<!-- ⚙️ ADMIN -->
<div class="admin-btn" onclick="openAdmin()">⚙️</div>

<div class="admin-panel" id="adminPanel">
  <div class="admin-box">
    <h2>Mode Admin</h2>

    <label>Takt time (minutes)</label>
    <input type="number" id="adminTakt">

    <label>Objectif du jour</label>
    <input type="number" id="adminTarget">

    <label>Réalisé</label>
    <input type="number" id="adminDone">

    <label>Message info (local)</label>
    <textarea id="adminInfo" rows="4"></textarea>

    <div class="admin-actions">
      <button onclick="togglePause()">Pause / Reprise</button>
      <button onclick="resetTimer()" class="danger">Reset timer</button>
      <button onclick="saveAdmin()" class="close">Enregistrer</button>
      <button onclick="closeAdmin()">Fermer</button>
    </div>
  </div>
</div>

<!-- ===== ÉCRAN PROD ===== -->
<div class="screen">
  <div class="takt">
    <div class="takt-label">TAKT TIME</div>
    <div class="takt-time" id="timeLeft">00:00:00</div>

    <div class="takt-sub">
      Objectif : <span id="taktMinutes">180</span> minutes
    </div>

    <div class="takt-actions">
      <button onclick="togglePause()" id="pauseBtn">⏸ Pause</button>
      <button onclick="resetCycle()" class="reset">⟳ Fin de cycle</button>
    </div>

    <div class="pause-indicator" id="pauseIndicator">
      ⏸ EN PAUSE
    </div>
  </div>

  <div class="bottom">
    <div class="card">
      <h2>OBJECTIF DU JOUR</h2>
      <div class="big"><span id="done">0</span> / <span id="target">10</span></div>
      <div class="small">Reste : <span id="remaining">10</span></div>
    </div>

    <div class="card">
      <h2>INFO / CONSIGNES</h2>
      <div class="info" id="infoText">—</div>

      <!-- ✅ Liste des PC / écrans -->
      <div class="pc-picker">
        <select id="pcSelect"></select>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG GOOGLE SHEET ================= */
const SHEET_ID = "1rqtagt5yFWq7CCvMymb0ZPhnvoBoFc2KO3TChLhHmh0";
const PC_ID = "pc1";              // PC par défaut au 1er chargement
const SHEET_REFRESH = 60000;      // 1 minute

/* ================= LOCAL STATE ================= */
const KEY = "ligne_prod_final";

let state = {
  taktMinutes: 180,
  target: 10,
  done: 0,
  info: "",
  paused: false,
  startTime: Date.now(),
  pausedAt: null
};

function load() {
  const s = localStorage.getItem(KEY);
  if (s) state = JSON.parse(s);
}

function save() {
  localStorage.setItem(KEY, JSON.stringify(state));
}

/* ================= CAROUSEL STATE (REMOTE) ================= */
const infoEl = document.getElementById("infoText");
const pcSelect = document.getElementById("pcSelect");

let rows = [];
let carouselMessages = [];
let carouselIndex = 0;
let carouselDelaySec = 15;
let carouselTimer = null;

/* ===== Helper: petite transition ===== */
function showInfo(text) {
  infoEl.style.opacity = 0;
  setTimeout(() => {
    infoEl.textContent = text || "—";
    infoEl.style.opacity = 1;
  }, 200);
}

/* ================= GOOGLE SHEET SYNC + CAROUSEL ================= */
async function fetchRemoteInfo() {
  try {
    const selectedId = pcSelect.value || PC_ID;

    const url = `https://opensheet.elk.sh/${SHEET_ID}/1`;
    const r = await fetch(url, { cache: "no-store" });
    rows = await r.json();

    // Rebuild select (sans reset utilisateur)
    pcSelect.innerHTML = "";
    rows.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.titre || r.id;
      pcSelect.appendChild(opt);
    });

    // Restaurer sélection si possible
    if (rows.some(r => r.id === selectedId)) {
      pcSelect.value = selectedId;
    } else if (rows.some(r => r.id === PC_ID)) {
      pcSelect.value = PC_ID;
    } else if (rows.length > 0) {
      pcSelect.value = rows[0].id;
    }

    // Mettre à jour le carrousel pour l'id choisi
    updateCarouselFromSelectedRow();

  } catch (e) {
    // silence : fallback local (on garde state.info)
  }
}

function updateCarouselFromSelectedRow() {
  const id = pcSelect.value || PC_ID;
  const row = rows.find(r => r.id === id);
  if (!row) return;

  // ⚠️ Colonnes attendues en minuscules : msg1/msg2/msg3/delay
  const msgs = [row.msg1, row.msg2, row.msg3].filter(m => m && String(m).trim());

  const newDelay = parseInt(row.delay, 10);
  const delay = Number.isFinite(newDelay) && newDelay > 0 ? newDelay : 15;

  // Si pas de messages dans le sheet, on garde éventuellement le local (state.info)
  if (msgs.length === 0) {
    carouselMessages = [];
    if (carouselTimer) clearInterval(carouselTimer);
    carouselTimer = null;

    // fallback local
    showInfo(state.info || "—");
    return;
  }

  // Détecter si le contenu/délai a changé (pour éviter reset inutile)
  const sameMsgs = JSON.stringify(carouselMessages) === JSON.stringify(msgs);
  const sameDelay = carouselDelaySec === delay;

  carouselMessages = msgs;
  carouselDelaySec = delay;

  // (Re)lancer carrousel seulement si besoin
  if (!sameMsgs || !sameDelay || !carouselTimer) {
    carouselIndex = 0;
    if (carouselTimer) clearInterval(carouselTimer);
    showInfo(carouselMessages[carouselIndex]);

    carouselTimer = setInterval(() => {
      if (carouselMessages.length <= 1) return;
      carouselIndex = (carouselIndex + 1) % carouselMessages.length;
      showInfo(carouselMessages[carouselIndex]);
    }, carouselDelaySec * 1000);
  }
}

// Quand l'utilisateur change de PC dans la liste
pcSelect.addEventListener("change", () => {
  updateCarouselFromSelectedRow();
});

/* ================= TIMER ================= */
function format(sec) {
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

setInterval(() => {
  if (state.paused) return;
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const remaining = state.taktMinutes * 60 - elapsed;
  const el = document.getElementById("timeLeft");

  el.textContent = remaining >= 0 ? format(remaining) : "-" + format(Math.abs(remaining));
  el.classList.toggle("alert", remaining < 0);
}, 1000);

/* ================= ACTIONS ================= */
function togglePause() {
  if (!state.paused) {
    state.pausedAt = Date.now();
    state.paused = true;
  } else {
    state.startTime += Date.now() - state.pausedAt;
    state.paused = false;
  }
  save();
  render();
}

function resetCycle() {
  state.done += 1;
  state.startTime = Date.now();
  state.paused = false;
  save();
  render();
}

function resetTimer() {
  state.startTime = Date.now();
  save();
}

/* ================= RENDER ================= */
function render() {
  document.getElementById("taktMinutes").textContent = state.taktMinutes;
  document.getElementById("target").textContent = state.target;
  document.getElementById("done").textContent = state.done;
  document.getElementById("remaining").textContent = state.target - state.done;

  // ⚠️ infoText est maintenant piloté par le carrousel (sheet) + fallback local
  // Donc on ne force plus ici state.info (sinon ça écrase le carrousel)

  const pauseIndicator = document.getElementById("pauseIndicator");
  const pauseBtn = document.getElementById("pauseBtn");

  if (state.paused) {
    pauseIndicator.style.display = "block";
    document.body.classList.add("paused");
    pauseBtn.textContent = "▶ Reprendre";
  } else {
    pauseIndicator.style.display = "none";
    document.body.classList.remove("paused");
    pauseBtn.textContent = "⏸ Pause";
  }
}

/* ================= ADMIN ================= */
function openAdmin() {
  adminPanel.style.display = "flex";
  adminTakt.value = state.taktMinutes;
  adminTarget.value = state.target;
  adminDone.value = state.done;
  adminInfo.value = state.info;
}

function closeAdmin() {
  adminPanel.style.display = "none";
}

function saveAdmin() {
  state.taktMinutes = +adminTakt.value;
  state.target = +adminTarget.value;
  state.done = +adminDone.value;
  state.info = adminInfo.value;
  save();
  render();
  closeAdmin();

  // Si le sheet n'a pas de messages, on reflète le local tout de suite
  if (!carouselMessages || carouselMessages.length === 0) {
    showInfo(state.info || "—");
  }
}

/* ================= INIT ================= */
load();
render();

// init select + carrousel depuis sheet
fetchRemoteInfo();
setInterval(fetchRemoteInfo, SHEET_REFRESH);

// afficher fallback local au tout début (si sheet lent)
showInfo(state.info || "—");
</script>

</body>
</html>

