<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Affichage Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: #f4f6f8;
  color: #111;
  font-family: Arial, Helvetica, sans-serif;
}

.screen {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== TOP ===== */
.top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 40px;
  background: #ffffff;
  border-bottom: 3px solid #e5e7eb;
}

.top h1 {
  margin: 0;
  font-size: 32px;
}

/* ===== TAKT ===== */
.takt {
  flex: 2;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.takt-label {
  font-size: 28px;
  opacity: 0.7;
}

.takt-time {
  font-size: 150px;
  font-weight: bold;
  margin: 10px 0;
}

.alert {
  color: #dc2626;
}

/* ===== INFO ===== */
.bottom {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  border-top: 3px solid #e5e7eb;
}

.card {
  padding: 40px;
}

.card h2 {
  font-size: 28px;
  margin-top: 0;
  opacity: 0.7;
}

.big {
  font-size: 70px;
  font-weight: bold;
}

.info {
  font-size: 48px;
  line-height: 1.3;
  transition: opacity .5s;
}

/* ===== SELECT ===== */
.select-box {
  position: fixed;
  top: 20px;
  right: 20px;
}

select {
  font-size: 16px;
  padding: 6px;
}
</style>
</head>

<body>

<div class="select-box">
  <select id="pcSelect"></select>
</div>

<div class="screen">

  <div class="top">
    <h1 id="titre">Production</h1>
    <div id="emplacement"></div>
  </div>

  <div class="takt">
    <div class="takt-label">TAKT TIME</div>
    <div class="takt-time" id="timeLeft">00:00:00</div>
  </div>

  <div class="bottom">
    <div class="card">
      <h2>OBJECTIF DU JOUR</h2>
      <div class="big">—</div>
    </div>

    <div class="card">
      <h2>INFO / CONSIGNES</h2>
      <div class="info" id="message">—</div>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzmEt8XciNrp5e2jFIAPJYTsOOTKTGMCmj8iURdTt5_8F8cd-fH8WTNT07N953K_dUY/exec";
const REFRESH_SHEET = 15000; // ms
/* ========================================== */

let rows = [];
let currentPC = null;
let messages = [];
let msgIndex = 0;
let msgTimer = null;

/* ===== TIME ===== */
function format(sec) {
  const h = String(Math.floor(sec / 3600)).padStart(2,"0");
  const m = String(Math.floor((sec % 3600)/60)).padStart(2,"0");
  const s = String(sec % 60).padStart(2,"0");
  return `${h}:${m}:${s}`;
}

setInterval(() => {
  const now = new Date();
  document.getElementById("timeLeft").textContent = format(
    now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds()
  );
}, 1000);

/* ===== LOAD ===== */
async function load() {
  const r = await fetch(API_URL, { cache: "no-store" });
  rows = await r.json();

  pcSelect.innerHTML = "";
  rows.forEach(r => {
    const o = document.createElement("option");
    o.value = r.id;
    o.textContent = r.titre || r.id;
    pcSelect.appendChild(o);
  });

  if (!currentPC && rows.length) {
    currentPC = rows[0].id;
    pcSelect.value = currentPC;
  }

  applyPC();
}

/* ===== APPLY ===== */
function applyPC() {
  const r = rows.find(x => x.id === pcSelect.value);
  if (!r) return;

  currentPC = r.id;

  titre.textContent = r.titre || "";
  emplacement.textContent = r.emplacement || "";

  messages = [r.msg1, r.msg2, r.msg3].filter(m => m && m.trim());
  msgIndex = 0;

  clearInterval(msgTimer);
  showMessage();

  const delay = Math.max(1, Number(r.delay) || 10) * 1000;
  msgTimer = setInterval(nextMessage, delay);
}

function showMessage() {
  message.style.opacity = 0;
  setTimeout(() => {
    message.textContent = messages[msgIndex] || "—";
    message.style.opacity = 1;
  }, 300);
}

function nextMessage() {
  if (!messages.length) return;
  msgIndex = (msgIndex + 1) % messages.length;
  showMessage();
}

pcSelect.addEventListener("change", applyPC);

/* AUTO REFRESH */
setInterval(load, REFRESH_SHEET);

/* INIT */
load();
</script>

</body>
</html>
